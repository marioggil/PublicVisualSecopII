<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rankings de Contratos</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .rankings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ranking-section {
            background: #344953;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ranking-section h2 {
            background:#34495e;
            color: white;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .ranking-table td {
            padding: 10px 12px;
            
        }



        .ranking-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .ranking-number.gold { background: #f39c12; }
        .ranking-number.silver { background: #95a5a6; }
        .ranking-number.bronze { background: #cd7f32; }

        .valor-text {
            color: #27ae60;
            font-weight: 600;
        }

        .retraso-bar {
            height: 20px;
        
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .retraso-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        .estado-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .estado-activo { background: #d4edda; color: #155724; }
        .estado-ejecucion { background: #fff3cd; color: #856404; }
        .estado-terminado { background: #cce5ff; color: #004085; }
        .estado-liquidado { background: #d1ecf1; color: #0c5460; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .full-width-section {
            grid-column: 1 / -1;
        }

        .badge-pyme {
            background: #1dc96a;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
        }

        .ejecucion-info {
           
            padding: 8px;
            margin-top: 5px;
            border-left: 3px solid #3498db;
            border-radius: 3px;
            font-size: 11px;
        }

        .cantidad-badge {
            display: inline-block;
            
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 10px;
        }
    </style>
    
</head>
<body>
    <div class="container">
        <h1>üìä Rankings de Contratos P√∫blicos</h1>

        <div class="rankings-grid">
            <!-- Contratos m√°s grandes -->
            <div class="ranking-section full-width-section">
                <h2>üí∞ Contratos con Mayor Valor</h2>
                <div id="ranking-valor" class="loading">Cargando...</div>
            </div>

            <!-- Proveedores con m√°s contratos -->
            <div class="ranking-section">
                <h2>üè¢ Proveedores con M√°s Contratos</h2>
                <div id="ranking-proveedores" class="loading">Cargando...</div>
            </div>

            <!-- Entidades con m√°s contratos -->
            <div class="ranking-section">
                <h2>üèõÔ∏è Entidades con M√°s Contratos</h2>
                <div id="ranking-entidades" class="loading">Cargando...</div>
            </div>

            <!-- Ejecuciones con mayor retraso -->
            <div class="ranking-section full-width-section">
                <h2>‚ö†Ô∏è Ejecuciones con Mayor Retraso</h2>
                <div id="ranking-retrasos" class="loading">Cargando...</div>
            </div>
        </div>
    </div>

    <script>
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function getRankingBadge(index) {
            if (index === 0) return '<span class="ranking-number gold">' + (index + 1) + '</span>';
            if (index === 1) return '<span class="ranking-number silver">' + (index + 1) + '</span>';
            if (index === 2) return '<span class="ranking-number bronze">' + (index + 1) + '</span>';
            return '<span class="ranking-number">' + (index + 1) + '</span>';
        }

        // Cargar ranking de contratos por valor
        fetch('/api/contratos/ranking-valor{{ str_url_tail }}')
            .then(r => r.json())
            .then(data => {
                const html = `
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 60px">#</th>
                                <th>Referencia</th>
                                <th>Entidad</th>
                                <th>Proveedor</th>
                                <th>Valor</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.contratos.map((c, i) => `
                                <tr>
                                    <td>${getRankingBadge(i)}</td>
                                    <td><strong>${c.referencia}</strong></td>
                                    <td>${c.nombre_entidad}</td>
                                    <td>${c.nombre_proveedor}</td>
                                    <td class="valor-text">${formatCurrency(c.valor_contrato)}</td>
                                    <td><span class="estado-badge estado-${c.estado.toLowerCase().replace(' ', '-')}">${c.estado}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('ranking-valor').innerHTML = html;
            })
            .catch(e => {
                document.getElementById('ranking-valor').innerHTML = '<p>Error al cargar datos</p>';
            });

        // Cargar ranking de proveedores
        fetch('/api/proveedores/ranking-contratos{{ str_url_tail }}')
            .then(r => r.json())
            .then(data => {
                const html = `
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 50px">#</th>
                                <th>Proveedor</th>
                                <th style="text-align: center">Contratos</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.proveedores.map((p, i) => `
                                <tr>
                                    <td>${getRankingBadge(i)}</td>
                                    <td>
                                        ${p.nombre}
                                        ${p.es_pyme === 'S√≠' ? '<span class="badge-pyme">PYME</span>' : ''}
                                    </td>
                                    <td style="text-align: center; font-weight: bold">${p.cantidad_contratos}</td>
                                    <td class="valor-text">${formatCurrency(p.valor_total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('ranking-proveedores').innerHTML = html;
            })
            .catch(e => {
                document.getElementById('ranking-proveedores').innerHTML = '<p>Error al cargar datos</p>';
            });

        // Cargar ranking de entidades
        fetch('/api/entidades/ranking-contratos{{ str_url_tail }}')
            .then(r => r.json())
            .then(data => {
                const html = `
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 50px">#</th>
                                <th>Entidad</th>
                                <th style="text-align: center">Contratos</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.entidades.map((e, i) => `
                                <tr>
                                    <td>${getRankingBadge(i)}</td>
                                    <td>
                                        ${e.nombre}<br>
                                        <small style="color: #7f8c8d">${e.departamento}</small>
                                    </td>
                                    <td style="text-align: center; font-weight: bold">${e.cantidad_contratos}</td>
                                    <td class="valor-text">${formatCurrency(e.valor_total)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('ranking-entidades').innerHTML = html;
            })
            .catch(e => {
                document.getElementById('ranking-entidades').innerHTML = '<p>Error al cargar datos</p>';
            });

        // Cargar ranking de retrasos (ejecuciones espec√≠ficas)
        fetch('/api/contratos/ranking-retrasos{{ str_url_tail }}')
            .then(r => r.json())
            .then(data => {
                const html = `
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 50px">#</th>
                                <th>Contrato y Ejecuci√≥n</th>
                                <th>Entidad / Proveedor</th>
                                <th style="text-align: center">Avance<br>Esperado</th>
                                <th style="text-align: center">Avance<br>Real</th>
                                <th style="width: 180px">Retraso</th>
                                <th>Valor<br>Contrato</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.ejecuciones.map((e, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>
                                        <strong>${e.referencia}</strong>
                                        <span class="estado-badge estado-${e.estado_contrato.toLowerCase().replace(' ', '-')}">${e.estado_contrato}</span>
                                        <div class="ejecucion-info">
                                            <strong>üìã ${e.ejecucion.tipo_ejecucion}</strong>
                                            <span style="float: right; background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px">
                                                ${e.ejecucion.estado_ejecucion}
                                            </span>
                                            <br>
                                            ${e.ejecucion.nombre_plan}<br>
                                            ${e.ejecucion.descripcion && e.ejecucion.descripcion !== 'N/A' ? '<small>' + e.ejecucion.descripcion.substring(0, 80) + '...</small>' : ''}
                                            <br>
                                            <span class="cantidad-badge">
                                                Recibido: ${e.ejecucion.cantidad_recibida} / ${e.ejecucion.cantidad_planeada} ${e.ejecucion.unidad}
                                            </span>
                                            <span class="cantidad-badge" style="background: #fee; color: #c00">
                                                Por recibir: ${e.ejecucion.cantidad_por_recibir} ${e.ejecucion.unidad}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>${e.nombre_entidad}</strong><br>
                                        <small style="color: #7f8c8d">${e.nombre_proveedor}</small>
                                    </td>
                                    <td style="text-align: center">
                                        <strong style="color: #27ae60">${e.ejecucion.porcentaje_avance_esperado.toFixed(1)}%</strong>
                                    </td>
                                    <td style="text-align: center">
                                        <strong style="color: #e74c3c">${e.ejecucion.porcentaje_avance_real.toFixed(1)}%</strong>
                                    </td>
                                    <td>
                                        <div class="retraso-bar">
                                            <div class="retraso-fill" style="width: ${Math.min(100, e.ejecucion.retraso_porcentual)}%">
                                                ${e.ejecucion.retraso_porcentual.toFixed(1)}%
                                            </div>
                                        </div>
                                        <small style="color: #7f8c8d">
                                            Esperado: ${e.ejecucion.fecha_entrega_esperada ? new Date(e.ejecucion.fecha_entrega_esperada).toLocaleDateString() : 'N/A'}
                                        </small>
                                    </td>
                                    <td class="valor-text">${formatCurrency(e.valor_contrato)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('ranking-retrasos').innerHTML = html;
            })
            .catch(e => {
                console.error('Error:', e);
                document.getElementById('ranking-retrasos').innerHTML = '<p>Error al cargar datos</p>';
            });
    </script>
</body>
</html>